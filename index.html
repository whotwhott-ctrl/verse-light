<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Verselight</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0d0d12;
      --bg-card: #16161d;
      --bg-hover: #1e1e28;
      --bg-input: #1a1a24;
      --border: #2a2a3a;
      --text-primary: #e8e6f0;
      --text-secondary: #8888a0;
      --text-muted: #5a5a70;
      --accent: #f4a0b0;
      --accent-hover: #f8b8c4;
      --accent-dim: rgba(244, 160, 176, 0.15);
      --danger: #e07080;
      --success: #80d0a0;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .page {
      display: none;
      min-height: 100vh;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    .header {
      text-align: center;
      padding: 40px 0 30px;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 2.5em;
      font-style: italic;
      color: var(--accent);
      letter-spacing: 0.05em;
      margin-bottom: 5px;
    }

    .tagline {
      color: var(--text-muted);
      font-size: 0.9em;
      font-weight: 300;
    }

    .btn {
      background: var(--accent);
      color: var(--bg-dark);
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.95em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .btn-secondary:hover {
      background: var(--accent-dim);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.85em;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #e88090;
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--bg-hover);
      color: var(--accent);
    }

    input[type="text"], input[type="file"], textarea, select {
      background: var(--bg-input);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 12px 16px;
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 0.95em;
      width: 100%;
      transition: border-color 0.2s;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238888a0' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }

    input[type="file"] {
      padding: 10px;
    }

    input[type="file"]::file-selector-button {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent);
      padding: 6px 12px;
      border-radius: 8px;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.2s;
    }

    input[type="file"]::file-selector-button:hover {
      background: var(--accent);
      color: var(--bg-dark);
    }

    label {
      display: block;
      color: var(--text-secondary);
      font-size: 0.85em;
      margin-bottom: 6px;
      font-weight: 400;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .card-title {
      font-size: 1.1em;
      font-weight: 500;
      color: var(--text-primary);
    }

    .server-grid {
      display: grid;
      gap: 12px;
      margin: 20px 0;
    }

    .server-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
    }

    .server-item:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
    }

    .server-name {
      font-weight: 500;
      font-size: 1.05em;
    }

    .server-count {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .server-arrow {
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .server-item:hover .server-arrow {
      transform: translateX(4px);
      color: var(--accent);
    }

    .new-server-form {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .new-server-form input {
      flex: 1;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .back-btn {
      color: var(--text-secondary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      transition: color 0.2s;
    }

    .back-btn:hover {
      color: var(--accent);
    }

    .server-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.4em;
      font-style: italic;
      color: var(--accent);
    }

    .composer {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }

    .composer-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 15px;
    }

    .composer-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-hover);
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .composer-select {
      flex: 1;
    }

    .composer-textarea {
      margin-bottom: 15px;
    }

    .composer-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .composer-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .image-preview {
      margin: 10px 0;
      position: relative;
      display: none;
    }

    .image-preview img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 12px;
    }

    .image-preview-remove {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      cursor: pointer;
      font-size: 16px;
    }

    .post {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: border-color 0.2s;
      animation: fadeIn 0.3s ease;
    }

    .post:hover {
      border-color: #3a3a4a;
    }

    .post-header {
      display: flex;
      gap: 12px;
    }

    .post-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--bg-hover);
      object-fit: cover;
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.2s;
      border: 2px solid var(--border);
    }

    .post-avatar:hover {
      transform: scale(1.05);
      border-color: var(--accent);
    }

    .post-content {
      flex: 1;
      min-width: 0;
    }

    .post-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      flex-wrap: wrap;
    }

    .post-name {
      font-weight: 600;
      color: var(--text-primary);
      cursor: pointer;
      transition: color 0.2s;
    }

    .post-name:hover {
      color: var(--accent);
    }

    .post-time {
      color: var(--text-muted);
      font-size: 0.85em;
    }

    .post-text {
      color: var(--text-primary);
      margin: 8px 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .post-image {
      margin-top: 12px;
      border-radius: 12px;
      max-width: 100%;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .post-image:hover {
      transform: scale(1.01);
    }

    .post-actions {
      display: flex;
      gap: 4px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }

    .character-card {
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .character-card:hover, .character-card.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
    }

    .character-card-avatar {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      margin: 0 auto 10px;
      background: var(--bg-card);
      object-fit: cover;
      border: 2px solid var(--border);
    }

    .character-card.selected .character-card-avatar {
      border-color: var(--accent);
    }

    .character-card-name {
      font-weight: 500;
      font-size: 0.9em;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .profile-header {
      text-align: center;
      padding: 30px 20px;
      background: linear-gradient(180deg, var(--accent-dim) 0%, transparent 100%);
      border-radius: 16px;
      margin-bottom: 24px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin: 0 auto 15px;
      background: var(--bg-card);
      object-fit: cover;
      border: 3px solid var(--accent);
    }

    .profile-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.8em;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .profile-bio {
      color: var(--text-secondary);
      font-size: 0.95em;
      max-width: 400px;
      margin: 0 auto;
    }

    .profile-posts-header {
      color: var(--text-secondary);
      font-size: 0.9em;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 12px 20px;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .empty-state-subtext {
      font-size: 0.9em;
      opacity: 0.7;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 24px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 1.2em;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5em;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .form-actions .btn {
      flex: 1;
    }

    .lightbox {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      cursor: pointer;
    }

    .lightbox.active {
      display: flex;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 8px;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 480px) {
      .page {
        padding: 15px;
      }

      .logo {
        font-size: 2em;
      }

      .post {
        padding: 15px;
      }

      .post-avatar, .composer-avatar {
        width: 40px;
        height: 40px;
      }

      .character-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
    }
  </style>
</head>
<body>

  <div id="serverPage" class="page active">
    <div class="header">
      <div class="logo">Verselight</div>
      <div class="tagline">where stories come alive</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">Your Worlds</span>
      </div>
      
      <div id="serverList" class="server-grid"></div>

      <div class="new-server-form">
        <input type="text" id="newServerInput" placeholder="Create new world...">
        <button class="btn" onclick="createServer()">Create</button>
      </div>
    </div>
  </div>

  <div id="timelinePage" class="page">
    <div class="timeline-header">
      <span class="back-btn" onclick="showPage('server')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back
      </span>
      <span class="server-title" id="currentServerTitle">World Name</span>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('timeline')">Timeline</div>
      <div class="tab" onclick="switchTab('characters')">Characters</div>
    </div>

    <div id="timelineTab">
      <div class="composer">
        <div class="composer-header">
          <img id="composerAvatar" class="composer-avatar" src="" alt="">
          <select id="aliasSelect" class="composer-select" onchange="updateComposerAvatar()">
            <option value="">Select character...</option>
          </select>
        </div>
        <textarea id="postContent" class="composer-textarea" placeholder="What are they thinking?"></textarea>
        <div class="image-preview" id="imagePreview">
          <img id="imagePreviewImg" src="">
          <button class="image-preview-remove" onclick="clearImagePreview()">Ã—</button>
        </div>
        <div class="composer-footer">
          <div class="composer-actions">
            <label class="btn-icon" title="Add image">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <polyline points="21 15 16 10 5 21"/>
              </svg>
              <input type="file" id="postImageInput" accept="image/*" onchange="previewImage()" style="display:none">
            </label>
          </div>
          <button class="btn" onclick="createPost()">Post</button>
        </div>
      </div>

      <div id="postsContainer"></div>
    </div>

    <div id="charactersTab" style="display:none;">
      <div class="card">
        <div class="card-header">
          <span class="card-title">Your Characters</span>
          <button class="btn btn-small" onclick="openCharacterModal()">+ New</button>
        </div>
        <div id="characterGrid" class="character-grid"></div>
      </div>
    </div>
  </div>

  <div id="profilePage" class="page">
    <div class="timeline-header">
      <span class="back-btn" onclick="showPage('timeline')">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Back
      </span>
    </div>

    <div class="profile-header">
      <img id="profileAvatar" class="profile-avatar" src="" alt="">
      <div id="profileName" class="profile-name">Character Name</div>
      <div id="profileBio" class="profile-bio">Character bio goes here...</div>
      <div style="margin-top: 15px;">
        <button class="btn btn-small btn-secondary" onclick="editCurrentProfileCharacter()">Edit Character</button>
      </div>
    </div>

    <div class="profile-posts-header">Posts by this character</div>
    <div id="profilePosts"></div>
  </div>

  <div id="characterModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title" id="characterModalTitle">New Character</span>
        <button class="modal-close" onclick="closeCharacterModal()">Ã—</button>
      </div>
      
      <div class="form-group">
        <label>Character Name</label>
        <input type="text" id="characterNameInput" placeholder="Enter name...">
      </div>

      <div class="form-group">
        <label>Avatar</label>
        <input type="file" id="characterAvatarInput" accept="image/*">
      </div>

      <div class="form-group">
        <label>Bio</label>
        <textarea id="characterBioInput" placeholder="Tell us about this character..."></textarea>
      </div>

      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeCharacterModal()">Cancel</button>
        <button class="btn" onclick="saveCharacter()">Save</button>
      </div>

      <div id="deleteCharacterSection" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
        <button class="btn btn-danger btn-small" onclick="deleteCharacter()" style="width: 100%;">Delete Character</button>
      </div>
    </div>
  </div>

  <div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="">
  </div>

<script>
let data = JSON.parse(localStorage.getItem("verselight")) || { servers: {} };
let currentServer = null;
let currentProfileCharacter = null;
let editingCharacterIndex = null;

function saveData() {
  localStorage.setItem("verselight", JSON.stringify(data));
}

function showPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(page + 'Page').classList.add('active');
  
  if (page === 'server') renderServers();
  else if (page === 'timeline') renderTimeline();
  else if (page === 'profile') renderProfile();
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  document.getElementById('timelineTab').style.display = tab === 'timeline' ? 'block' : 'none';
  document.getElementById('charactersTab').style.display = tab === 'characters' ? 'block' : 'none';
  
  if (tab === 'characters') renderCharacters();
}

function renderServers() {
  const container = document.getElementById('serverList');
  const servers = Object.keys(data.servers);
  
  if (servers.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">âœ¨</div>
        <div class="empty-state-text">No worlds yet</div>
        <div class="empty-state-subtext">Create your first world to begin</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = servers.map(name => {
    const server = data.servers[name];
    const postCount = server.posts?.length || 0;
    const charCount = server.characters?.length || 0;
    return `
      <div class="server-item" onclick="enterServer('${name}')">
        <div>
          <div class="server-name">${name}</div>
          <div class="server-count">${charCount} characters Â· ${postCount} posts</div>
        </div>
        <span class="server-arrow">â†’</span>
      </div>
    `;
  }).join('');
}

function createServer() {
  const input = document.getElementById('newServerInput');
  const name = input.value.trim();
  if (!name || data.servers[name]) return;
  data.servers[name] = { characters: [], posts: [] };
  saveData();
  renderServers();
  input.value = '';
}

function enterServer(name) {
  currentServer = name;
  document.getElementById('currentServerTitle').textContent = name;
  showPage('timeline');
}

function renderTimeline() {
  renderAliasSelect();
  renderPosts();
}

function renderAliasSelect() {
  const select = document.getElementById('aliasSelect');
  const server = data.servers[currentServer];
  if (!server) return;
  select.innerHTML = '<option value="">Select character...</option>' +
    server.characters.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
  updateComposerAvatar();
}

function updateComposerAvatar() {
  const select = document.getElementById('aliasSelect');
  const avatar = document.getElementById('composerAvatar');
  const server = data.servers[currentServer];
  if (select.value && server?.characters[select.value]) {
    const char = server.characters[select.value];
    avatar.src = char.avatar || '';
    avatar.style.display = char.avatar ? 'block' : 'none';
  } else {
    avatar.style.display = 'none';
  }
}

function previewImage() {
  const input = document.getElementById('postImageInput');
  const preview = document.getElementById('imagePreview');
  const img = document.getElementById('imagePreviewImg');
  if (input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      img.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function clearImagePreview() {
  document.getElementById('postImageInput').value = '';
  document.getElementById('imagePreview').style.display = 'none';
}

function createPost() {
  const select = document.getElementById('aliasSelect');
  const content = document.getElementById('postContent');
  const imageInput = document.getElementById('postImageInput');
  if (!select.value) { alert('Please select a character first!'); return; }
  const text = content.value.trim();
  const hasImage = imageInput.files[0];
  if (!text && !hasImage) return;
  
  const processPost = (imageData = null) => {
    const server = data.servers[currentServer];
    server.posts.unshift({
      characterIndex: parseInt(select.value),
      text: text,
      image: imageData,
      timestamp: Date.now()
    });
    saveData();
    renderPosts();
    content.value = '';
    clearImagePreview();
  };
  
  if (hasImage) {
    const reader = new FileReader();
    reader.onload = e => processPost(e.target.result);
    reader.readAsDataURL(imageInput.files[0]);
  } else {
    processPost();
  }
}

function renderPosts() {
  const container = document.getElementById('postsContainer');
  const server = data.servers[currentServer];
  if (!server?.posts?.length) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ’­</div>
        <div class="empty-state-text">No posts yet</div>
        <div class="empty-state-subtext">Create a character and start posting!</div>
      </div>
    `;
    return;
  }
  
  container.innerHTML = server.posts.map((post, postIndex) => {
    const char = server.characters[post.characterIndex];
    if (!char) return '';
    const time = formatTime(post.timestamp);
    return `
      <div class="post">
        <div class="post-header">
          <img class="post-avatar" src="${char.avatar || ''}" 
               style="${char.avatar ? '' : 'background: var(--bg-hover);'}"
               onclick="viewProfile(${post.characterIndex})" alt="${char.name}">
          <div class="post-content">
            <div class="post-meta">
              <span class="post-name" onclick="viewProfile(${post.characterIndex})">${char.name}</span>
              <span class="post-time">Â· ${time}</span>
            </div>
            ${post.text ? `<div class="post-text">${escapeHtml(post.text)}</div>` : ''}
            ${post.image ? `<img class="post-image" src="${post.image}" onclick="openLightbox('${post.image}')">` : ''}
          </div>
        </div>
        <div class="post-actions">
          <button class="btn-icon" onclick="deletePost(${postIndex})" title="Delete post">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function deletePost(index) {
  if (!confirm('Delete this post?')) return;
  data.servers[currentServer].posts.splice(index, 1);
  saveData();
  renderPosts();
}

function renderCharacters() {
  const container = document.getElementById('characterGrid');
  const server = data.servers[currentServer];
  if (!server?.characters?.length) {
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1/-1;">
        <div class="empty-state-icon">ðŸ‘¤</div>
        <div class="empty-state-text">No characters yet</div>
        <div class="empty-state-subtext">Create your first character!</div>
      </div>
    `;
    return;
  }
  container.innerHTML = server.characters.map((char, i) => `
    <div class="character-card" onclick="openCharacterModal(${i})">
      <img class="character-card-avatar" src="${char.avatar || ''}" 
           style="${char.avatar ? '' : 'background: var(--bg-card);'}" alt="">
      <div class="character-card-name">${char.name}</div>
    </div>
  `).join('');
}

function openCharacterModal(index = null) {
  editingCharacterIndex = index;
  const modal = document.getElementById('characterModal');
  const title = document.getElementById('characterModalTitle');
  const nameInput = document.getElementById('characterNameInput');
  const bioInput = document.getElementById('characterBioInput');
  const deleteSection = document.getElementById('deleteCharacterSection');
  
  if (index !== null) {
    const char = data.servers[currentServer].characters[index];
    title.textContent = 'Edit Character';
    nameInput.value = char.name;
    bioInput.value = char.bio || '';
    deleteSection.style.display = 'block';
  } else {
    title.textContent = 'New Character';
    nameInput.value = '';
    bioInput.value = '';
    deleteSection.style.display = 'none';
  }
  document.getElementById('characterAvatarInput').value = '';
  modal.classList.add('active');
}

function closeCharacterModal() {
  document.getElementById('characterModal').classList.remove('active');
  editingCharacterIndex = null;
}

function saveCharacter() {
  const name = document.getElementById('characterNameInput').value.trim();
  const bio = document.getElementById('characterBioInput').value.trim();
  const avatarInput = document.getElementById('characterAvatarInput');
  if (!name) { alert('Please enter a character name!'); return; }
  
  const processCharacter = (avatarData = null) => {
    const server = data.servers[currentServer];
    if (editingCharacterIndex !== null) {
      server.characters[editingCharacterIndex].name = name;
      server.characters[editingCharacterIndex].bio = bio;
      if (avatarData) server.characters[editingCharacterIndex].avatar = avatarData;
    } else {
      server.characters.push({ name, bio, avatar: avatarData || '' });
    }
    saveData();
    closeCharacterModal();
    renderCharacters();
    renderAliasSelect();
  };
  
  if (avatarInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => processCharacter(e.target.result);
    reader.readAsDataURL(avatarInput.files[0]);
  } else {
    processCharacter();
  }
}

function deleteCharacter() {
  if (!confirm('Delete this character? Their posts will remain but show as "Unknown".')) return;
  data.servers[currentServer].characters.splice(editingCharacterIndex, 1);
  data.servers[currentServer].posts.forEach(post => {
    if (post.characterIndex === editingCharacterIndex) post.characterIndex = -1;
    else if (post.characterIndex > editingCharacterIndex) post.characterIndex--;
  });
  saveData();
  closeCharacterModal();
  renderCharacters();
  renderAliasSelect();
}

function viewProfile(characterIndex) {
  currentProfileCharacter = characterIndex;
  showPage('profile');
}

function renderProfile() {
  const server = data.servers[currentServer];
  const char = server?.characters[currentProfileCharacter];
  if (!char) return;
  document.getElementById('profileAvatar').src = char.avatar || '';
  document.getElementById('profileName').textContent = char.name;
  document.getElementById('profileBio').textContent = char.bio || 'No bio yet...';
  
  const container = document.getElementById('profilePosts');
  const posts = server.posts.filter(p => p.characterIndex === currentProfileCharacter);
  if (!posts.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-state-text">No posts yet</div></div>`;
    return;
  }
  container.innerHTML = posts.map((post, i) => {
    const time = formatTime(post.timestamp);
    return `
      <div class="post">
        <div class="post-text">${escapeHtml(post.text || '')}</div>
        ${post.image ? `<img class="post-image" src="${post.image}" onclick="openLightbox('${post.image}')">` : ''}
        <div class="post-time" style="margin-top: 8px;">${time}</div>
      </div>
    `;
  }).join('');
}

function editCurrentProfileCharacter() {
  openCharacterModal(currentProfileCharacter);
}

function openLightbox(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('active');
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('active');
}

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h';
  if (diff < 604800000) return Math.floor(diff / 86400000) + 'd';
  return date.toLocaleDateString();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

document.getElementById('newServerInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') createServer();
});

document.getElementById('postContent').addEventListener('keypress', e => {
  if (e.key === 'Enter' && e.ctrlKey) createPost();
});

renderServers();
</script>

</body>
</html>
